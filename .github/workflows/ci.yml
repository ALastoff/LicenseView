name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test-powershell:
    name: PowerShell Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        pwsh-version: ['7.0', '7.4']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Validate PowerShell Syntax
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          
          # Validate main script syntax
          $script = Get-Content "./zerto-licensing-report.ps1" -Raw
          $errors = $null
          [System.Management.Automation.PSParser]::Tokenize($script, [ref]$errors)
          
          if ($errors.Count -gt 0) {
            Write-Error "Syntax errors found in main script"
            $errors | Format-Table
            exit 1
          }
          
          Write-Host "✓ Main script syntax valid"
      
      - name: Load and Validate Modules
        shell: pwsh
        run: |
          $ModulePath = "./src/ps"
          $successCount = 0
          $failCount = 0
          
          Get-ChildItem "$ModulePath/*.psm1" | ForEach-Object {
            Write-Host "Testing module: $($_.Name)"
            try {
              Import-Module $_.FullName -Force -ErrorAction Stop
              Write-Host "✓ Module loaded successfully" -ForegroundColor Green
              $successCount++
            }
            catch {
              Write-Host "⚠ Module has dependencies: $($_.Name)" -ForegroundColor Yellow
              $failCount++
            }
          }
          
          Write-Host "`n$successCount modules loaded, $failCount have external dependencies"
          
          # Don't fail build if some modules have dependencies (they need ZertoAuth, etc.)
          if ($successCount -eq 0) {
            Write-Error "No modules could be loaded at all"
            exit 1
          }
      
      - name: Lint with PSScriptAnalyzer
        shell: pwsh
        run: |
          if (-not (Get-Module -Name PSScriptAnalyzer -ListAvailable)) {
            Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck -Scope CurrentUser
          }
          
          Write-Host "Running PSScriptAnalyzer..."
          
          # Run analyzer but don't fail on warnings (informational only for v1.0)
          Invoke-ScriptAnalyzer -Path "./src/ps/" -Recurse -ReportSummary || echo "Analysis completed with suggestions"

  test-python:
    name: Python Tests
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          echo "Pip upgraded successfully"
      
      - name: Verify Python structure
        run: |
          python -c "import sys; print('Python version:', sys.version)"
          python -c "import os; print('✓ main.py exists') if os.path.exists('main.py') else print('✗ main.py missing')"
          python -c "import os; print('✓ Python package exists') if os.path.isdir('src/py/zerto') else print('✗ Package missing')"

  validate-deliverables:
    name: Validate Project Deliverables
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check Critical Files
        run: |
          echo "Checking critical project files..."
          files=(
            "zerto-licensing-report.ps1"
            "main.py"
            "config.example.yaml"
            "src/ps/Zerto.Logging.psm1"
            "src/ps/Zerto.Config.psm1"
            "src/ps/Zerto.Data.psm1"
            "src/ps/Zerto.Output.psm1"
            "src/ps/Zerto.History.psm1"
            "README.md"
            "LICENSE"
          )
          
          for file in "${files[@]}"; do
            if [ ! -f "$file" ]; then
              echo "ERROR: Missing critical file: $file"
              exit 1
            fi
          done
          
          echo "✓ All critical files present"
      
      - name: Check Documentation
        run: |
          echo "Checking documentation..."
          if [ ! -s "README.md" ]; then
            echo "ERROR: README.md is empty or missing"
            exit 1
          fi
          echo "✓ Documentation check complete"
      
      - name: Check Code Structure
        run: |
          echo "Checking code structure..."
          ps_modules=$(find src/ps -name "*.psm1" | wc -l)
          echo "PowerShell modules: $ps_modules"
          py_modules=$(find src/py -name "*.py" | wc -l)
          echo "Python modules: $py_modules"
          echo "✓ Code structure check complete"

  build-status:
    name: Build Status Summary
    runs-on: ubuntu-latest
    needs: [test-powershell, test-python, validate-deliverables]
    if: always()
    
    steps:
      - name: Build Summary
        run: |
          echo "# CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "- PowerShell Tests: ${{ needs.test-powershell.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Python Tests: ${{ needs.test-python.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deliverables: ${{ needs.validate-deliverables.result }}" >> $GITHUB_STEP_SUMMARY
